{%- comment -%}
  Teamwear Config – Einseiten-Konfigurator mit Steps und Animationen
  Step 1: Sportart wählen (farbige 3D-Karten)
  Step 2: Design wählen (Produkte aus je Sport-Kollektion)
  Step 3: Farbauswahl (Platzhalter – wird nach Designauswahl angezeigt)
{%- endcomment -%}

{%- style -%}
  #shopify-section-{{ section.id }} .twc-container {
    max-width: 1160px;
    margin: 0 auto;
    padding: 0 24px;
  }
  #shopify-section-{{ section.id }} .twc-header {
    text-align: center;
    margin: 0 0 24px;
  }
  #shopify-section-{{ section.id }} .twc-step-title {
    font-size: clamp(1.25rem, 1rem + 1.2vw, 2rem);
    font-weight: 800;
    margin: 0 0 6px;
  }
  #shopify-section-{{ section.id }} .twc-step-sub {
    color: #667085;
    margin: 0;
  }

  /* Grid der Sportarten – nicht volle Breite, schöne Karten */
  #shopify-section-{{ section.id }} .twc-grid {
    display: grid;
    grid-template-columns: repeat(5, minmax(0, 1fr));
    gap: 14px;
  }
  @media (max-width: 1100px) {
    #shopify-section-{{ section.id }} .twc-grid {
      grid-template-columns: repeat(3, minmax(0, 1fr));
    }
  }
  @media (max-width: 700px) {
    #shopify-section-{{ section.id }} .twc-grid {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }
  }

  #shopify-section-{{ section.id }} .sport-card {
    border-radius: 14px;
    overflow: hidden;
    background: #fff;
    box-shadow: 0 10px 30px rgba(16,24,40,.08), inset 0 0 0 1px rgba(0,0,0,.04);
    transform: translateY(0) translateZ(0);
    transition: transform .25s cubic-bezier(.2,.6,.2,1), box-shadow .25s, filter .25s;
    will-change: transform;
    perspective: 1000px;
    cursor: pointer;
  }
  #shopify-section-{{ section.id }} .sport-card__media {
    height: 96px;
    display: grid;
    place-items: center;
    color: #fff;
    font-size: 30px;
    background: var(--grad, linear-gradient(90deg,#0ea5e9,#6366f1));
  }
  #shopify-section-{{ section.id }} .sport-card__body { padding: 12px 14px 14px; }
  #shopify-section-{{ section.id }} .sport-card__title { margin: 4px 0 2px; font-weight: 700; }
  #shopify-section-{{ section.id }} .sport-card__sub { margin: 0 0 10px; color: #667085; font-size: .9rem; }
  #shopify-section-{{ section.id }} .sport-card__cta { display: inline-flex; align-items: center; gap: 6px; color: #16a34a; font-weight: 700; text-decoration: none; }
  #shopify-section-{{ section.id }} .sport-card:hover { transform: translateY(-6px) translateZ(0); box-shadow: 0 18px 40px rgba(16,24,40,.14); filter: saturate(1.1); }

  /* Steps / View Transitions */
  #shopify-section-{{ section.id }} .twc-steps { position: relative; }
  #shopify-section-{{ section.id }} .twc-step { opacity: 0; transform: translateY(10px); transition: opacity .25s, transform .25s; display: none; }
  #shopify-section-{{ section.id }} .twc-step.is-active { display: block; opacity: 1; transform: translateY(0); }

  /* Produktgrid (Step 2) */
  #shopify-section-{{ section.id }} .design-grid { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 16px; }
  @media (max-width: 900px) { #shopify-section-{{ section.id }} .design-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
  @media (max-width: 600px) { #shopify-section-{{ section.id }} .design-grid { grid-template-columns: 1fr; } }

  #shopify-section-{{ section.id }} .design-card { border-radius: 12px; overflow: hidden; background: #fff; box-shadow: 0 8px 24px rgba(16,24,40,.08); transition: transform .22s, box-shadow .22s, outline .2s; cursor: pointer; outline: 2px solid transparent; display:flex; flex-direction:column; }
  #shopify-section-{{ section.id }} .design-card:hover { transform: translateY(-4px); box-shadow: 0 14px 34px rgba(16,24,40,.14); }
  #shopify-section-{{ section.id }} .design-card.is-selected { outline: 2px solid #111827; box-shadow: 0 0 0 2px #111827 inset, 0 14px 34px rgba(16,24,40,.14); }
  #shopify-section-{{ section.id }} .design-card__media { aspect-ratio: 1/1; background: #f3f4f6; display: grid; place-items: center; flex: 1 1 auto; }
  #shopify-section-{{ section.id }} .design-card__media img { width: 100%; height: 100%; object-fit: cover; }
  #shopify-section-{{ section.id }} .design-card__body { padding: 12px; }
  #shopify-section-{{ section.id }} .design-card__title { margin: 0 0 4px; font-weight: 700; }
  #shopify-section-{{ section.id }} .design-card__price { color: #111827; font-weight: 700; }
  #shopify-section-{{ section.id }} .design-card__cta { margin-top: 8px; display: inline-block; font-weight: 700; }
  #shopify-section-{{ section.id }} .design-swatches { display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; }
  #shopify-section-{{ section.id }} .design-swatch { padding:6px 10px; border:1px solid #e5e7eb; border-radius:999px; background:#fff; cursor:pointer; font-size:12px; display:inline-flex; align-items:center; gap:6px; }
  #shopify-section-{{ section.id }} .design-swatch.is-active { background:#111827; color:#fff; border-color:#111827; }
  #shopify-section-{{ section.id }} .design-swatch__dot { width:14px; height:14px; border-radius:50%; border:1px solid #e5e7eb; background:var(--sw-color,#e5e7eb); }

  /* Step 3 (Farben) – Placeholder */
  #shopify-section-{{ section.id }} .colors-panel { border-radius: 12px; background: #fafafa; padding: 16px; border: 1px solid #eee; }
  #shopify-section-{{ section.id }} .color-group { margin-bottom: 16px; }
  #shopify-section-{{ section.id }} .color-group__title { font-weight: 700; margin-bottom: 8px; }
  #shopify-section-{{ section.id }} .swatches { display: flex; flex-wrap: wrap; gap: 8px; }
  #shopify-section-{{ section.id }} .swatch { width: 28px; height: 28px; border-radius: 50%; border: 2px solid #fff; box-shadow: 0 0 0 1px rgba(0,0,0,.1); cursor: pointer; }
  #shopify-section-{{ section.id }} .swatch.is-active { box-shadow: 0 0 0 2px #111827; }
  #shopify-section-{{ section.id }} .uploader { display: grid; gap: 8px; margin-top: 8px; }
  #shopify-section-{{ section.id }} .uploader input[type="file"] { display: block; background: #fff; border: 1px solid #e5e7eb; border-radius: 8px; padding: 8px; }
  #shopify-section-{{ section.id }} .twc-actions { margin-top: 16px; display: flex; gap: 10px; justify-content: space-between; align-items: center; }
  #shopify-section-{{ section.id }} .twc-summary-bottom { color:#0f172a; font-weight:600; }
  #shopify-section-{{ section.id }} .players { margin-top: 16px; }
  #shopify-section-{{ section.id }} .players__controls { display: flex; gap: 12px; align-items: center; margin-bottom: 10px; }
  #shopify-section-{{ section.id }} .players__controls input[type="number"] { width: 90px; padding: 6px 8px; border: 1px solid #e5e7eb; border-radius: 8px; }
  #shopify-section-{{ section.id }} .players__panel { display: block; border: 1px solid #e5e7eb; background: #fff; border-radius: 10px; padding: 12px; }
  #shopify-section-{{ section.id }} .players-table { width: 100%; border-collapse: collapse; }
  #shopify-section-{{ section.id }} .players-table th, #shopify-section-{{ section.id }} .players-table td { border-bottom: 1px solid #f1f5f9; padding: 8px; text-align: left; }
  #shopify-section-{{ section.id }} .players-table input, #shopify-section-{{ section.id }} .players-table select { width: 100%; padding: 6px 8px; border: 1px solid #e5e7eb; border-radius: 8px; }

  /* Step 3 – Design Vorschau oben */
  #shopify-section-{{ section.id }} .design-preview { display:grid; grid-template-columns: 1fr; gap: 10px; margin-bottom: 14px; }
  #shopify-section-{{ section.id }} .design-preview__media { position:relative; border:1px solid #eee; border-radius: 10px; overflow:hidden; background:#fff; max-width: 560px; margin: 0 auto; aspect-ratio: 1 / 1; display:grid; place-items:center; }
  #shopify-section-{{ section.id }} .design-preview__stage img { width:100%; height:100%; object-fit: contain; display:block; }
  #shopify-section-{{ section.id }} .design-preview__nav { position:absolute; top:50%; transform: translateY(-50%); background: rgba(255,255,255,.9); border:1px solid #e5e7eb; width:36px; height:36px; border-radius:999px; display:grid; place-items:center; cursor:pointer; }
  #shopify-section-{{ section.id }} .design-preview__nav:hover { background:#fff; }
  #shopify-section-{{ section.id }} .design-preview__nav.prev { left:8px; }
  #shopify-section-{{ section.id }} .design-preview__nav.next { right:8px; }
  #shopify-section-{{ section.id }} .design-preview__swatches { display:flex; gap:8px; flex-wrap:wrap; }

  /* Step 3 – Layout wie PDP: links Medien, rechts Infos */
  #shopify-section-{{ section.id }} .step3-grid { display:grid; grid-template-columns: minmax(260px,560px) 1fr; gap: 24px; align-items:start; }
  @media (max-width: 900px) { #shopify-section-{{ section.id }} .step3-grid { grid-template-columns: 1fr; } }
  #shopify-section-{{ section.id }} .step3-right__title { margin: 0 0 8px; font-weight: 800; font-size: clamp(1.125rem, 1rem + .5vw, 1.375rem); }
  #shopify-section-{{ section.id }} .step3-section { border:1px solid #e5e7eb; background:#fff; border-radius: 10px; padding: 10px; margin: 10px 0; }
  #shopify-section-{{ section.id }} .step3-label { display:block; font-weight:700; margin-bottom:6px; }
  #shopify-section-{{ section.id }} .step3-qty input[type="number"] { width: 110px; }

  /* Menge & Preise (Step 2) */
  #shopify-section-{{ section.id }} .qty-panel { display:none; margin: 12px 0 18px; border: 1px solid #e5e7eb; border-radius: 12px; padding: 12px; background: #fff; }
  #shopify-section-{{ section.id }} .qty-grid { display:flex; flex-wrap:wrap; gap:10px; }
  #shopify-section-{{ section.id }} .qty-btn { min-width:90px; padding:10px 12px; border:1px solid #e5e7eb; border-radius: 10px; background: #f8fafc; cursor:pointer; }
  #shopify-section-{{ section.id }} .qty-btn.active { background:#111827; color:#fff; border-color:#111827; }
  #shopify-section-{{ section.id }} .price-summary { margin-top:10px; display:flex; gap:14px; flex-wrap:wrap; align-items:center; font-weight:600; }
  #shopify-section-{{ section.id }} .price-summary small { font-weight:400; color:#64748b; }
  #shopify-section-{{ section.id }} .step-actions { display:flex; justify-content:flex-end; gap:12px; margin-top:14px; }
  /* Bottom actions (Step 2) */
  #shopify-section-{{ section.id }} .step-actions--bottom { justify-content:flex-start; margin-top:20px; }
  #shopify-section-{{ section.id }} .button--ghost {
    background: transparent;
    color: #64748b;
    border: 1px solid #e5e7eb;
    box-shadow: none;
    padding: 8px 10px;
    border-radius: 10px;
  }
  #shopify-section-{{ section.id }} .button--ghost:hover {
    color: #0f172a;
    background: #f8fafc;
    border-color: #e5e7eb;
  }

  /* Stepper */
  #shopify-section-{{ section.id }} .twc-stepper { margin: 0 0 14px; display:flex; justify-content:center; }
  #shopify-section-{{ section.id }} .twc-stepper__list { list-style:none; margin:0; padding:0; display:flex; gap:18px; align-items:center; }
  #shopify-section-{{ section.id }} .twc-stepper__item { display:flex; align-items:center; gap:8px; color:#94a3b8; font-weight:600; }
  #shopify-section-{{ section.id }} .twc-stepper__bullet { width:22px; height:22px; border-radius:50%; border:1px solid #e5e7eb; display:grid; place-items:center; background:#fff; font-size:12px; }
  #shopify-section-{{ section.id }} .twc-stepper__item.is-done { color:#16a34a; }
  #shopify-section-{{ section.id }} .twc-stepper__item.is-done .twc-stepper__bullet { background:#16a34a; color:#fff; border-color:#16a34a; }
  #shopify-section-{{ section.id }} .twc-stepper__item.is-current { color:#0f172a; }
  #shopify-section-{{ section.id }} .twc-stepper__item.is-current .twc-stepper__bullet { border-color:#0f172a; }
{%- endstyle -%}

<div class="twc" data-section="{{ section.id }}" data-quantities="{{ section.settings.tiers_quantities }}" data-discounts="{{ section.settings.tiers_discounts }}" data-price-logo="{{ section.settings.price_logo }}" data-price-number-chest="{{ section.settings.price_number_chest }}" data-price-number-back="{{ section.settings.price_number_back }}" data-price-team-name="{{ section.settings.price_team_name }}" data-price-player-name="{{ section.settings.price_player_name }}">
  <div class="twc-container">
      <nav class="twc-stepper" aria-label="Konfigurator Schritte">
        <ol class="twc-stepper__list" data-stepper>
          <li class="twc-stepper__item is-current" data-stepper-item="1"><span class="twc-stepper__bullet">1</span><span>Sportart</span></li>
          <li class="twc-stepper__item" data-stepper-item="2"><span class="twc-stepper__bullet">2</span><span>Design</span></li>
          <li class="twc-stepper__item" data-stepper-item="3"><span class="twc-stepper__bullet">3</span><span>Personalisierung</span></li>
        </ol>
      </nav>
      <div class="twc-steps">
      <!-- Step 1: Sportarten -->
      <section class="twc-step is-active" data-step="1">
        <header class="twc-header">
          <div class="twc-step-title">{{ section.settings.step1_title }}</div>
          <p class="twc-step-sub">{{ section.settings.step1_sub }}</p>
        </header>
        <div class="twc-grid">
          <article class="sport-card" tabindex="0" role="button" aria-label="{{ section.settings.bb_title }} wählen" data-sport="basketball" style="--grad: {{ section.settings.bb_gradient }}">
            <div class="sport-card__media"><span aria-hidden="true">{{ section.settings.bb_icon }}</span></div>
            <div class="sport-card__body">
              <div class="sport-card__title">{{ section.settings.bb_title }}</div>
              <div class="sport-card__sub">{{ section.settings.bb_sub }}</div>
              <a href="#" class="sport-card__cta" data-action="choose-sport" data-target="basketball">{{ section.settings.cta_choose }}</a>
            </div>
          </article>
          <article class="sport-card" tabindex="0" role="button" aria-label="{{ section.settings.fb_title }} wählen" data-sport="fussball" style="--grad: {{ section.settings.fb_gradient }}">
            <div class="sport-card__media"><span aria-hidden="true">{{ section.settings.fb_icon }}</span></div>
            <div class="sport-card__body">
              <div class="sport-card__title">{{ section.settings.fb_title }}</div>
              <div class="sport-card__sub">{{ section.settings.fb_sub }}</div>
              <a href="#" class="sport-card__cta" data-action="choose-sport" data-target="fussball">{{ section.settings.cta_choose }}</a>
            </div>
          </article>
          <article class="sport-card" tabindex="0" role="button" aria-label="{{ section.settings.hb_title }} wählen" data-sport="handball" style="--grad: {{ section.settings.hb_gradient }}">
            <div class="sport-card__media"><span aria-hidden="true">{{ section.settings.hb_icon }}</span></div>
            <div class="sport-card__body">
              <div class="sport-card__title">{{ section.settings.hb_title }}</div>
              <div class="sport-card__sub">{{ section.settings.hb_sub }}</div>
              <a href="#" class="sport-card__cta" data-action="choose-sport" data-target="handball">{{ section.settings.cta_choose }}</a>
            </div>
          </article>
          <article class="sport-card" tabindex="0" role="button" aria-label="{{ section.settings.vb_title }} wählen" data-sport="volleyball" style="--grad: {{ section.settings.vb_gradient }}">
            <div class="sport-card__media"><span aria-hidden="true">{{ section.settings.vb_icon }}</span></div>
            <div class="sport-card__body">
              <div class="sport-card__title">{{ section.settings.vb_title }}</div>
              <div class="sport-card__sub">{{ section.settings.vb_sub }}</div>
              <a href="#" class="sport-card__cta" data-action="choose-sport" data-target="volleyball">{{ section.settings.cta_choose }}</a>
            </div>
          </article>
          <article class="sport-card" tabindex="0" role="button" aria-label="{{ section.settings.tt_title }} wählen" data-sport="tischtennis" style="--grad: {{ section.settings.tt_gradient }}">
            <div class="sport-card__media"><span aria-hidden="true">{{ section.settings.tt_icon }}</span></div>
            <div class="sport-card__body">
              <div class="sport-card__title">{{ section.settings.tt_title }}</div>
              <div class="sport-card__sub">{{ section.settings.tt_sub }}</div>
              <a href="#" class="sport-card__cta" data-action="choose-sport" data-target="tischtennis">{{ section.settings.cta_choose }}</a>
            </div>
          </article>
        </div>
      </section>

      <!-- Step 2: Designs je Sportart -->
      <section class="twc-step" data-step="2">
        <header class="twc-header">
          <div class="twc-step-title">{{ section.settings.step2_title }}</div>
          <p class="twc-step-sub">{{ section.settings.step2_sub }}</p>
        </header>

        <!-- Design-Grids kommen hier; Back-Button unten (nicht überdeckend) -->

        <div class="design-grid" data-designs-for="basketball" style="display:none;" data-grid>
          {%- if section.settings.bb_collection != blank -%}
            {%- for product in section.settings.bb_collection.products limit: 9 -%}
                <article class="design-card" data-design-card-id="{{ product.id }}" data-product-id="{{ product.selected_or_first_available_variant.id }}" data-product-handle="{{ product.handle }}">
                <div class="design-card__media">{%- if product.featured_image -%}{{ product.featured_image | image_url: width: 600 | image_tag: loading: 'lazy', alt: product.title | escape }}{%- endif -%}</div>
                <div class="design-card__body"><div class="design-card__title">{{ product.title }}</div><div class="design-card__price">{{ product.selected_or_first_available_variant.price | money }}</div>
                {%- assign color_options = product.options_with_values | where: 'name', 'Farbe' -%}
                {%- if color_options.size > 0 -%}
                  <div class="design-swatches" data-color-swatches data-product-id="{{ product.id }}">
                    {%- for opt in color_options.first.values -%}
                      {%- assign variant = nil -%}
                      {%- for v in product.variants -%}
                        {%- if v.option1 == opt or v.option2 == opt or v.option3 == opt -%}
                          {%- assign variant = v -%}
                          {%- break -%}
                        {%- endif -%}
                      {%- endfor -%}
                      {%- assign swatch_color = variant.option1 | handleize | replace: 'schwarz', '000000' | replace: 'black', '000000' | replace: 'weiß', 'ffffff' | replace: 'weiss', 'ffffff' | replace: 'white', 'ffffff' | replace: 'rot', 'ff0000' | replace: 'red', 'ff0000' | replace: 'blau', '0000ff' | replace: 'blue', '0000ff' | replace: 'grün', '00a653' | replace: 'gruen', '00a653' | replace: 'green', '00a653' -%}
                      {%- assign chosen_variant = variant | default: product.selected_or_first_available_variant -%}
                      {%- assign chosen_media = chosen_variant.featured_media | default: product.featured_media -%}
                      <button type="button" class="design-swatch" data-action="choose-design" data-product-id="{{ chosen_variant.id }}" data-color-label="{{ opt }}" data-media-id="{{ chosen_media.id }}" data-image-url="{{ chosen_media | image_url: width: 800 }}" style="--sw-color:#{{ swatch_color }}">
                        <span class="design-swatch__dot"></span>
                        <span>{{ opt }}</span>
                      </button>
                    {%- endfor -%}
                  </div>
                {%- else -%}
                  <button type="button" class="button design-card__cta" data-action="choose-design" data-product-id="{{ product.selected_or_first_available_variant.id }}">{{ section.settings.cta_select_design }}</button>
                {%- endif -%}
                </div>
              </article>
            {%- endfor -%}
          {%- else -%}
            <div style="grid-column:1/-1;padding:12px;border:1px dashed #e5e7eb;border-radius:8px;background:#fafafa;">Für "Basketball" bitte eine Kollektion wählen.</div>
          {%- endif -%}
        </div>
        <div class="design-grid" data-designs-for="fussball" style="display:none;" data-grid>
          {%- if section.settings.fb_collection != blank -%}
            {%- for product in section.settings.fb_collection.products limit: 9 -%}
              <article class="design-card" data-design-card-id="{{ product.id }}" data-product-id="{{ product.selected_or_first_available_variant.id }}" data-product-handle="{{ product.handle }}">
                <div class="design-card__media">{%- if product.featured_image -%}{{ product.featured_image | image_url: width: 600 | image_tag: loading: 'lazy', alt: product.title | escape }}{%- endif -%}</div>
                <div class="design-card__body">
                  <div class="design-card__title">{{ product.title }}</div>
                  <div class="design-card__price">{{ product.selected_or_first_available_variant.price | money }}</div>
                  {%- assign color_options = product.options_with_values | where: 'name', 'Farbe' -%}
                  {%- if color_options.size > 0 -%}
                    <div class="design-swatches" data-color-swatches data-product-id="{{ product.id }}">
                      {%- for opt in color_options.first.values -%}
                        {%- assign variant = nil -%}
                        {%- for v in product.variants -%}
                          {%- if v.option1 == opt or v.option2 == opt or v.option3 == opt -%}
                            {%- assign variant = v -%}
                            {%- break -%}
                          {%- endif -%}
                        {%- endfor -%}
                        {%- assign swatch_source = variant.option1 | default: opt -%}
                        {%- assign swatch_color = swatch_source | handleize | replace: 'schwarz', '000000' | replace: 'black', '000000' | replace: 'weiß', 'ffffff' | replace: 'weiss', 'ffffff' | replace: 'white', 'ffffff' | replace: 'rot', 'ff0000' | replace: 'red', 'ff0000' | replace: 'blau', '0000ff' | replace: 'blue', '0000ff' | replace: 'grün', '00a653' | replace: 'gruen', '00a653' | replace: 'green', '00a653' -%}
                        {%- assign chosen_variant = variant | default: product.selected_or_first_available_variant -%}
                        {%- assign chosen_media = chosen_variant.featured_media | default: product.featured_media -%}
                        <button type="button" class="design-swatch" data-action="choose-design" data-product-id="{{ chosen_variant.id }}" data-color-label="{{ opt }}" data-media-id="{{ chosen_media.id }}" data-image-url="{{ chosen_media | image_url: width: 800 }}" style="--sw-color:#{{ swatch_color }}">
                          <span class="design-swatch__dot"></span>
                          <span>{{ opt }}</span>
                        </button>
                      {%- endfor -%}
                    </div>
                  {%- else -%}
                    <button type="button" class="button design-card__cta" data-action="choose-design" data-product-id="{{ product.selected_or_first_available_variant.id }}">{{ section.settings.cta_select_design }}</button>
                  {%- endif -%}
                </div>
              </article>
            {%- endfor -%}
          {%- else -%}
            <div style="grid-column:1/-1;padding:12px;border:1px dashed #e5e7eb;border-radius:8px;background:#fafafa;">Für "Fußball" bitte eine Kollektion wählen.</div>
          {%- endif -%}
        </div>
        <div class="design-grid" data-designs-for="handball" style="display:none;" data-grid>
          {%- if section.settings.hb_collection != blank -%}
            {%- for product in section.settings.hb_collection.products limit: 9 -%}
              <article class="design-card" data-design-card-id="{{ product.id }}" data-product-id="{{ product.selected_or_first_available_variant.id }}" data-product-handle="{{ product.handle }}">
                <div class="design-card__media">{%- if product.featured_image -%}{{ product.featured_image | image_url: width: 600 | image_tag: loading: 'lazy', alt: product.title | escape }}{%- endif -%}</div>
                <div class="design-card__body">
                  <div class="design-card__title">{{ product.title }}</div>
                  <div class="design-card__price">{{ product.selected_or_first_available_variant.price | money }}</div>
                  {%- assign color_options = product.options_with_values | where: 'name', 'Farbe' -%}
                  {%- if color_options.size > 0 -%}
                    <div class="design-swatches" data-color-swatches data-product-id="{{ product.id }}">
                      {%- for opt in color_options.first.values -%}
                        {%- assign variant = nil -%}
                        {%- for v in product.variants -%}
                          {%- if v.option1 == opt or v.option2 == opt or v.option3 == opt -%}
                            {%- assign variant = v -%}
                            {%- break -%}
                          {%- endif -%}
                        {%- endfor -%}
                        {%- assign swatch_source = variant.option1 | default: opt -%}
                        {%- assign swatch_color = swatch_source | handleize | replace: 'schwarz', '000000' | replace: 'black', '000000' | replace: 'weiß', 'ffffff' | replace: 'weiss', 'ffffff' | replace: 'white', 'ffffff' | replace: 'rot', 'ff0000' | replace: 'red', 'ff0000' | replace: 'blau', '0000ff' | replace: 'blue', '0000ff' | replace: 'grün', '00a653' | replace: 'gruen', '00a653' | replace: 'green', '00a653' -%}
                        {%- assign chosen_variant = variant | default: product.selected_or_first_available_variant -%}
                        {%- assign chosen_media = chosen_variant.featured_media | default: product.featured_media -%}
                        <button type="button" class="design-swatch" data-action="choose-design" data-product-id="{{ chosen_variant.id }}" data-color-label="{{ opt }}" data-media-id="{{ chosen_media.id }}" data-image-url="{{ chosen_media | image_url: width: 800 }}" style="--sw-color:#{{ swatch_color }}">
                          <span class="design-swatch__dot"></span>
                          <span>{{ opt }}</span>
                        </button>
                      {%- endfor -%}
                    </div>
                  {%- else -%}
                    <button type="button" class="button design-card__cta" data-action="choose-design" data-product-id="{{ product.selected_or_first_available_variant.id }}">{{ section.settings.cta_select_design }}</button>
                  {%- endif -%}
                </div>
              </article>
            {%- endfor -%}
          {%- else -%}
            <div style="grid-column:1/-1;padding:12px;border:1px dashed #e5e7eb;border-radius:8px;background:#fafafa;">Für "Handball" bitte eine Kollektion wählen.</div>
          {%- endif -%}
        </div>
        <div class="design-grid" data-designs-for="volleyball" style="display:none;" data-grid>
          {%- if section.settings.vb_collection != blank -%}
            {%- for product in section.settings.vb_collection.products limit: 9 -%}
              <article class="design-card" data-design-card-id="{{ product.id }}" data-product-id="{{ product.selected_or_first_available_variant.id }}" data-product-handle="{{ product.handle }}">
                <div class="design-card__media">{%- if product.featured_image -%}{{ product.featured_image | image_url: width: 600 | image_tag: loading: 'lazy', alt: product.title | escape }}{%- endif -%}</div>
                <div class="design-card__body">
                  <div class="design-card__title">{{ product.title }}</div>
                  <div class="design-card__price">{{ product.selected_or_first_available_variant.price | money }}</div>
                  {%- assign color_options = product.options_with_values | where: 'name', 'Farbe' -%}
                  {%- if color_options.size > 0 -%}
                    <div class="design-swatches" data-color-swatches data-product-id="{{ product.id }}">
                      {%- for opt in color_options.first.values -%}
                        {%- assign variant = nil -%}
                        {%- for v in product.variants -%}
                          {%- if v.option1 == opt or v.option2 == opt or v.option3 == opt -%}
                            {%- assign variant = v -%}
                            {%- break -%}
                          {%- endif -%}
                        {%- endfor -%}
                        {%- assign swatch_source = variant.option1 | default: opt -%}
                        {%- assign swatch_color = swatch_source | handleize | replace: 'schwarz', '000000' | replace: 'black', '000000' | replace: 'weiß', 'ffffff' | replace: 'weiss', 'ffffff' | replace: 'white', 'ffffff' | replace: 'rot', 'ff0000' | replace: 'red', 'ff0000' | replace: 'blau', '0000ff' | replace: 'blue', '0000ff' | replace: 'grün', '00a653' | replace: 'gruen', '00a653' | replace: 'green', '00a653' -%}
                        {%- assign chosen_variant = variant | default: product.selected_or_first_available_variant -%}
                        {%- assign chosen_media = chosen_variant.featured_media | default: product.featured_media -%}
                        <button type="button" class="design-swatch" data-action="choose-design" data-product-id="{{ chosen_variant.id }}" data-color-label="{{ opt }}" data-media-id="{{ chosen_media.id }}" data-image-url="{{ chosen_media | image_url: width: 800 }}" style="--sw-color:#{{ swatch_color }}">
                          <span class="design-swatch__dot"></span>
                          <span>{{ opt }}</span>
                        </button>
                      {%- endfor -%}
                    </div>
                  {%- else -%}
                    <button type="button" class="button design-card__cta" data-action="choose-design" data-product-id="{{ product.selected_or_first_available_variant.id }}">{{ section.settings.cta_select_design }}</button>
                  {%- endif -%}
                </div>
              </article>
            {%- endfor -%}
          {%- else -%}
            <div style="grid-column:1/-1;padding:12px;border:1px dashed #e5e7eb;border-radius:8px;background:#fafafa;">Für "Volleyball" bitte eine Kollektion wählen.</div>
          {%- endif -%}
        </div>
        <div class="design-grid" data-designs-for="tischtennis" style="display:none;" data-grid>
          {%- if section.settings.tt_collection != blank -%}
            {%- for product in section.settings.tt_collection.products limit: 9 -%}
              <article class="design-card" data-design-card-id="{{ product.id }}" data-product-id="{{ product.selected_or_first_available_variant.id }}" data-product-handle="{{ product.handle }}">
                <div class="design-card__media">{%- if product.featured_image -%}{{ product.featured_image | image_url: width: 600 | image_tag: loading: 'lazy', alt: product.title | escape }}{%- endif -%}</div>
                <div class="design-card__body">
                  <div class="design-card__title">{{ product.title }}</div>
                  <div class="design-card__price">{{ product.selected_or_first_available_variant.price | money }}</div>
                  {%- assign color_options = product.options_with_values | where: 'name', 'Farbe' -%}
                  {%- if color_options.size > 0 -%}
                    <div class="design-swatches" data-color-swatches data-product-id="{{ product.id }}">
                      {%- for opt in color_options.first.values -%}
                        {%- assign variant = nil -%}
                        {%- for v in product.variants -%}
                          {%- if v.option1 == opt or v.option2 == opt or v.option3 == opt -%}
                            {%- assign variant = v -%}
                            {%- break -%}
                          {%- endif -%}
                        {%- endfor -%}
                        {%- assign swatch_source = variant.option1 | default: opt -%}
                        {%- assign swatch_color = swatch_source | handleize | replace: 'schwarz', '000000' | replace: 'black', '000000' | replace: 'weiß', 'ffffff' | replace: 'weiss', 'ffffff' | replace: 'white', 'ffffff' | replace: 'rot', 'ff0000' | replace: 'red', 'ff0000' | replace: 'blau', '0000ff' | replace: 'blue', '0000ff' | replace: 'grün', '00a653' | replace: 'gruen', '00a653' | replace: 'green', '00a653' -%}
                        {%- assign chosen_variant = variant | default: product.selected_or_first_available_variant -%}
                        {%- assign chosen_media = chosen_variant.featured_media | default: product.featured_media -%}
                        <button type="button" class="design-swatch" data-action="choose-design" data-product-id="{{ chosen_variant.id }}" data-color-label="{{ opt }}" data-media-id="{{ chosen_media.id }}" data-image-url="{{ chosen_media | image_url: width: 800 }}" style="--sw-color:#{{ swatch_color }}">
                          <span class="design-swatch__dot"></span>
                          <span>{{ opt }}</span>
                        </button>
                      {%- endfor -%}
                    </div>
                  {%- else -%}
                    <button type="button" class="button design-card__cta" data-action="choose-design" data-product-id="{{ product.selected_or_first_available_variant.id }}">{{ section.settings.cta_select_design }}</button>
                  {%- endif -%}
                </div>
              </article>
            {%- endfor -%}
          {%- else -%}
            <div style="grid-column:1/-1;padding:12px;border:1px dashed #e5e7eb;border-radius:8px;background:#fafafa;">Für "Tischtennis" bitte eine Kollektion wählen.</div>
          {%- endif -%}
        </div>

        <div class="step-actions step-actions--bottom">
          <button type="button" class="button button--ghost" data-action="back-to-sports">Zurück zur Sportart</button>
          <button type="button" class="button button--primary" data-action="go-last-step">Letzter Schritt</button>
        </div>
      </section>

      <!-- Step 3: Farben (Placeholder/Startpunkt) -->
      <section class="twc-step" data-step="3">
        <header class="twc-header">
          <div class="twc-step-title">{{ section.settings.step3_title }}</div>
          <p class="twc-step-sub">{{ section.settings.step3_sub }}</p>
        </header>
        <div class="step3-grid">
          <div>
            <div class="design-preview" data-design-preview>
              <div class="design-preview__media">
                <button class="design-preview__nav prev" type="button" data-gallery-prev aria-label="Vorheriges Bild">❮</button>
                <div class="design-preview__stage" data-design-media></div>
                <button class="design-preview__nav next" type="button" data-gallery-next aria-label="Nächstes Bild">❯</button>
              </div>
            </div>
          </div>
          <div class="step3-right">
            <h3 class="step3-right__title" data-step3-title>–</h3>
            <div class="step3-section">
              <span class="step3-label">Farbe</span>
              <div class="design-preview__swatches" data-design-swatches></div>
            </div>
            <div class="step3-section">
              <span class="step3-label">Anzahl</span>
              <div class="step3-qty"><input type="number" min="1" value="10" data-qty-input></div>
            </div>
            <div class="step3-section">
              <span class="step3-label">Team</span>
              <label><input type="checkbox" data-opt-logo> Logo hinzufügen <span data-addon-price="logo"></span></label>
              <label style="display:block; margin-top:6px;"><input type="checkbox" data-opt-team-name> Teamname <span data-addon-price="team-name"></span></label>
              <div class="uploader" data-logo-uploader style="display:none; margin-top:8px;">
                <input type="file" accept="image/*" data-upload="logo">
              </div>
              <div data-teamname-field style="display:none; margin-top:8px;">
                <input type="text" placeholder="Teamname eingeben" data-field-team-name style="width:100%; padding:8px; border:1px solid #e5e7eb; border-radius:8px;">
              </div>
            </div>
            <div class="step3-section">
              <div><strong>Ausgewählte Menge:</strong> <span data-summary-qty>–</span> · <strong>Zwischensumme:</strong> <span data-summary-total>–</span></div>
            </div>
          </div>
        </div>

        <div class="colors-panel" data-colors-panel>

            <div class="color-group">
              <div class="color-group__title">Personalisierung</div>
              <div style="display:grid; gap:6px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); align-items:center;">
                <label><input type="checkbox" data-opt-number-chest> Nummer Brust <span data-addon-price="number-chest"></span></label>
                <label><input type="checkbox" data-opt-number-back> Nummer Rücken <span data-addon-price="number-back"></span></label>
                <label><input type="checkbox" data-opt-player-name> Spielernamen <span data-addon-price="player-name"></span></label>
              </div>
            <div class="personalization-fields" style="display:grid; grid-template-columns: 1fr; gap:8px; margin-top:8px;"></div>
          </div>

          <div class="players">
            
            <div class="players__panel" data-players-panel>
              <table class="players-table">
                <thead>
                  <tr>
                    <th>#</th>
                    <th data-col-name>Name</th>
                    <th data-col-number>Nummer</th>
                    <th>Größe</th>
                  </tr>
                </thead>
                <tbody data-players-body></tbody>
              </table>
            </div>
          </div>

          <div class="twc-actions">
            <div class="twc-summary-bottom"><strong>Zwischensumme:</strong> <span data-summary-total-bottom>–</span></div>
            <div style="display:flex; gap:10px;">
              <button type="button" class="button button--ghost" data-action="back-to-designs">Zurück zu Designs</button>
              <button type="button" class="button button--primary" data-action="add-to-cart">In den Warenkorb</button>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>
</div>

<script>
  (function(){
    const root = document.querySelector('#shopify-section-{{ section.id }} .twc');
    if(!root) return;

    // Entferne eventuell vorhandene alte Mengen-UI vollständig (nicht nur verstecken)
    const removeLegacyQtyUI = () => {
      try {
        root.querySelectorAll('[data-qty-panel], .qty-grid, .qty-btn').forEach(el => el.remove());
        delete root.dataset.selectedQty;
      } catch(_) {}
    };

    const setStepper = (nr) => {
      root.querySelectorAll('[data-stepper-item]').forEach((li) => {
        const step = parseInt(li.getAttribute('data-stepper-item'));
        li.classList.remove('is-current','is-done');
        if (step < nr) li.classList.add('is-done');
        if (step === nr) li.classList.add('is-current');
      });
    };

    const showStep = (nr) => {
      root.querySelectorAll('.twc-step').forEach(s => s.classList.remove('is-active'));
      const el = root.querySelector('.twc-step[data-step="'+nr+'"]');
      if(el) el.classList.add('is-active');
      window.scrollTo({top: root.offsetTop - 40, behavior: 'smooth'});
      setStepper(nr);
      if (nr === 3) {
        // Jetzt existieren die Summary-Elemente in Step 3 → aktualisieren
        try { updatePriceSummary && updatePriceSummary(); } catch(e) {}
      }
      // Sicherheitshalber alte Mengen-UI in jedem Schritt entfernen
      removeLegacyQtyUI();
    };

    const goToDesigns = (id) => {
      root.querySelectorAll('[data-designs-for]').forEach(g => g.style.display = 'none');
      const grid = root.querySelector('[data-designs-for="'+id+'"]');
      if(grid) {
        grid.style.display = 'grid';
        showStep(2);
      } else {
        showStep(2);
      }
      removeLegacyQtyUI();
    };

    // Step 1 → Step 2 (klickbar: ganze Karte, CTA, Enter/Space)
    root.addEventListener('click', (e) => {
      const card = e.target.closest('.sport-card');
      const choose = e.target.closest('[data-action="choose-sport"]');
      if(!card && !choose) return;
      e.preventDefault();
      const id = (choose || card).getAttribute('data-target') || card.getAttribute('data-sport');
      if(!id) return;
      // Reset previously selected design so Preis wird vom aktiven Grid gelesen
      delete root.dataset.selectedDesignId;
      goToDesigns(id);
    });

    root.addEventListener('keydown', (e) => {
      if((e.key === 'Enter' || e.key === ' ') && e.target.closest('.sport-card')) {
        e.preventDefault();
        const id = e.target.getAttribute('data-sport');
        if(id) goToDesigns(id);
      }
    });

    // Keine Mengenwahl in Step 2 mehr

    // Design auswählen (Klick auf Karte, Button oder Farbe)
    root.addEventListener('click', (e) => {
      const btn = e.target.closest('[data-action="choose-design"]');
      const cardClick = e.target.closest('.design-card');
      if (!btn && !cardClick) return;
      e.preventDefault();
      const card = (btn ? btn.closest('.design-card') : cardClick);
      const id = (btn && btn.dataset.productId) ? btn.dataset.productId : card.getAttribute('data-product-id');
      if (card) root.dataset.selectedDesignId = card.getAttribute('data-design-card-id');
      root.dataset.selectedProduct = id;
      // Produkt-Handle für Step 3 speichern (falls vorhanden)
      const handle = card.getAttribute('data-product-handle');
      if (handle) root.dataset.selectedHandle = handle;
      // Markierung aktualisieren
      root.querySelectorAll('.design-card').forEach(c => c.classList.remove('is-selected'));
      card.classList.add('is-selected');
      // Farbswatch aktiv zustand
      if (btn && btn.classList.contains('design-swatch')) {
        card.querySelectorAll('.design-swatch').forEach(s => s.classList.remove('is-active'));
        btn.classList.add('is-active');
        // Bildwechsel auf Variantenbild (Shopify Variantenbild vorhanden)
        const media = card.querySelector('.design-card__media');
        const img = media && (media.querySelector('img') || media.querySelector('img, picture img'));
        const newUrl = btn.getAttribute('data-image-url');
        if (img && newUrl) {
          img.src = newUrl;
        }
      }
      // Direkt zu Step 3 wechseln, Menge wird dort abgefragt
      removeLegacyQtyUI();
      showStep(3);
      // Vorschau in Step 3 initial befüllen
      try { renderStep3DesignPreview && renderStep3DesignPreview(); } catch(_) {}
    });

    // Step 3 interactions (Klick)
    root.addEventListener('click', (e) => {
      const swatch = e.target.closest('.swatch');
      if (swatch) {
        const group = swatch.closest('.color-group');
        group.querySelectorAll('.swatch').forEach(s => s.classList.remove('is-active'));
        swatch.classList.add('is-active');
        return;
      }

      const back = e.target.closest('[data-action="back-to-designs"]');
      if (back) { showStep(2); return; }
      const backToSports = e.target.closest('[data-action="back-to-sports"]');
      if (backToSports) {
        // Reset Selektion und Panels
        root.querySelectorAll('[data-designs-for]').forEach(g => g.style.display = 'none');
        root.querySelectorAll('.design-card').forEach(c => c.classList.remove('is-selected'));
        const qtyPanel = root.querySelector('[data-qty-panel]');
        if (qtyPanel) qtyPanel.style.display = 'none';
        delete root.dataset.selectedProduct;
        delete root.dataset.selectedDesignId;
        delete root.dataset.selectedQty;
        showStep(1);
        return;
      }
      const goLast = e.target.closest('[data-action="go-last-step"]');
      if (goLast) { showStep(3); return; }

      const add = e.target.closest('[data-action="add-to-cart"]');
      if (add) {
        const id = Number(root.dataset.selectedProduct || 0);
        const qtyInput = root.querySelector('[data-qty-input]');
        const quantity = Math.max(parseInt((qtyInput && qtyInput.value) || root.dataset.selectedQty || '1'), 1);
        if (!id) { alert('Bitte zuerst ein Design wählen.'); return; }
        add.setAttribute('disabled', 'disabled');
        fetch('/cart/add.js', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' }, body: JSON.stringify({ id, quantity, properties: { _teamwear: 'true' } }) })
          .then(r => r.json())
          .then(() => { add.removeAttribute('disabled'); alert('Zum Warenkorb hinzugefügt.'); })
          .catch(() => { add.removeAttribute('disabled'); alert('Fehler beim Hinzufügen.'); });
      }

      // Logo Toggle via Klick auf das Label (falls Browser das change-Event später feuert)
      const logoToggle = e.target.closest('[data-opt-logo]');
      if (logoToggle) {
        const up = root.querySelector('[data-logo-uploader]');
        if (up) up.style.display = logoToggle.checked ? 'block' : 'none';
        updatePriceSummary();
      }
    });

    // Spielerlisten-Panel – dynamischer Aufbau je Menge/Optionen
    const buildPlayers = () => {
      const panel = root.querySelector('[data-players-panel]');
      const body = root.querySelector('[data-players-body]');
      const qtyInput = root.querySelector('[data-qty-input]');
      const count = Math.max(parseInt((qtyInput && qtyInput.value) || root.dataset.selectedQty || '0'), 1);
      const sizes = 'XS,S,M,L,XL'.split(',');
      body.innerHTML = '';
      for (let i = 1; i <= count; i++) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${i}</td><td data-cell-name><input type="text" placeholder="Name"></td><td data-cell-number><input type="text" placeholder="Nr."></td><td><select>${sizes.map(s => `<option>${s}</option>`).join('')}</select></td>`;
        body.appendChild(tr);
      }
      // Spalten-Sichtbarkeit anhand neuer Checkboxen
      const showName = !!root.querySelector('[data-opt-player-name]')?.checked;
      const showNumber = !!root.querySelector('[data-opt-number-chest]')?.checked || !!root.querySelector('[data-opt-number-back]')?.checked;
      root.querySelector('[data-col-name]').style.display = showName ? '' : 'none';
      root.querySelector('[data-col-number]').style.display = showNumber ? '' : 'none';
      body.querySelectorAll('[data-cell-name]').forEach(td => td.style.display = showName ? '' : 'none');
      body.querySelectorAll('[data-cell-number]').forEach(td => td.style.display = showNumber ? '' : 'none');
    };

    root.addEventListener('change', (e) => {
      // Größenliste ändert die Options in den Selects
      if (e.target.matches('[data-size-list]')) { buildPlayers(); return; }

      // Logo Toggle -> Uploader anzeigen/verstecken
      if (e.target.matches('[data-opt-logo]')) {
        const up = root.querySelector('[data-logo-uploader]');
        if (up) up.style.display = e.target.checked ? 'block' : 'none';
        updatePriceSummary();
        return;
      }

      // Teamname Toggle -> Eingabefeld anzeigen/verstecken
      if (e.target.matches('[data-opt-team-name]')) {
        const field = root.querySelector('[data-teamname-field]');
        if (field) field.style.display = e.target.checked ? 'block' : 'none';
        updatePriceSummary();
        return;
      }

      // Spielername/Nummer -> Spalten neu anwenden
      if (
        e.target.matches('[data-opt-player-name]') ||
        e.target.matches('[data-opt-number-chest]') ||
        e.target.matches('[data-opt-number-back]')
      ) {
        buildPlayers();
        updatePriceSummary();
        return;
      }
    });

    // Rabatt-/Preislogik – über Theme‑Settings steuerbar
    const getBasePrice = () => {
      // Wenn bereits ein Design geklickt wurde, Preis an der Karte auslesen
      const activeId = root.dataset.selectedDesignId;
      if (activeId) {
        const priceEl = root.querySelector(`[data-design-card-id="${activeId}"] .design-card__price`);
        if (priceEl) {
          const text = priceEl.textContent.replace(/[^0-9,\.]/g, '').replace(',', '.');
          const value = parseFloat(text);
          if (!isNaN(value)) return value;
        }
      }
      const any = root.querySelector('[data-designs-for]:not([style*="display: none"]) .design-card__price');
      if (!any) return 0;
      const text = any.textContent.replace(/[^0-9,\.]/g, '').replace(',', '.');
      const value = parseFloat(text);
      return isNaN(value) ? 0 : value;
    };

    function calcDiscount(qty){
      // Map Mengen → Rabatt aus Settings
      const quantities = (root.dataset.quantities || '').split(',').map(s => parseInt(s.trim())).filter(Boolean);
      const discounts = (root.dataset.discounts || '').split(',').map(s => parseFloat(s.trim().replace(',', '.'))).filter(n => !isNaN(n));
      let applied = 0;
      for (let i = 0; i < quantities.length; i++) {
        if (qty >= quantities[i]) applied = discounts[i] || applied;
      }
      return applied;
    }

    function updatePriceSummary(){
      const input = root.querySelector('[data-qty-input]');
      const qty = parseInt(input && input.value ? input.value : (root.dataset.selectedQty || '0'));
      if (!qty) return;
      const base = getBasePrice();
      const discount = calcDiscount(qty);
      const unit = base * (1 - discount/100);
      const total = unit * qty;
      const fmt = (n) => new Intl.NumberFormat('de-DE', { style: 'currency', currency: '{{ cart.currency.iso_code }}' }).format(n);
      const elTotal = root.querySelector('[data-price-total]');
      const elUnit = root.querySelector('[data-price-unit]');
      const elDisc = root.querySelector('[data-discount]');
      if (elTotal) elTotal.textContent = fmt(total);
      if (elUnit) elUnit.textContent = fmt(unit);
      if (elDisc) elDisc.textContent = discount + '%';
      // Zusatzkosten anzeigen
      const priceMap = {
        'logo': parseFloat(root.dataset.priceLogo || '0'),
        'number-chest': parseFloat(root.dataset.priceNumberChest || '0'),
        'number-back': parseFloat(root.dataset.priceNumberBack || '0'),
        'team-name': parseFloat(root.dataset.priceTeamName || '0'),
        'player-name': parseFloat(root.dataset.pricePlayerName || '0')
      };
      Object.entries(priceMap).forEach(([key, val]) => {
        const holder = root.querySelector(`[data-addon-price="${key}"]`);
        if (holder) {
          holder.textContent = val > 0 ? `(${fmt(val)} pro Stk.)` : '';
        }
      });
      const isLogo = !!root.querySelector('[data-opt-logo]')?.checked;
      const isNumChest = !!root.querySelector('[data-opt-number-chest]')?.checked;
      const isNumBack = !!root.querySelector('[data-opt-number-back]')?.checked;
      const isTeamName = !!root.querySelector('[data-opt-team-name]')?.checked;
      const isPlayerName = !!root.querySelector('[data-opt-player-name]')?.checked;
      const addonsPerUnit =
        (isLogo ? priceMap['logo'] : 0) +
        (isNumChest ? priceMap['number-chest'] : 0) +
        (isNumBack ? priceMap['number-back'] : 0) +
        (isTeamName ? priceMap['team-name'] : 0) +
        (isPlayerName ? priceMap['player-name'] : 0);
      const totalWithAddons = total + addonsPerUnit * qty;

      const savingsEl = root.querySelector('[data-savings]');
      if (savingsEl) {
        const savings = (base - unit) * qty;
        savingsEl.textContent = fmt(Math.max(0, savings));
      }
      // Summary in Step 3 spiegeln
      const sumQty = root.querySelector('[data-summary-qty]');
      const sumTotal = root.querySelector('[data-summary-total]');
      const sumTotalBottom = root.querySelector('[data-summary-total-bottom]');
      if (sumQty) sumQty.textContent = qty;
      if (sumTotal) sumTotal.textContent = fmt(totalWithAddons);
      if (sumTotalBottom) sumTotalBottom.textContent = fmt(totalWithAddons);
      // Tabelle an Menge anpassen
      buildPlayers();
    }

    // Step 3: Design-Vorschau und Farbswatches befüllen
    async function renderStep3DesignPreview(){
      const mediaHolder = root.querySelector('[data-design-media]');
      const swatchesHolder = root.querySelector('[data-design-swatches]');
      if (!mediaHolder || !swatchesHolder) return;
      mediaHolder.innerHTML = '';
      swatchesHolder.innerHTML = '';
      const handle = root.dataset.selectedHandle;
      const pid = root.dataset.selectedProduct;
      if (!handle && !pid) return;

      // Produktdaten via Shopify Sectionless JSON API laden (Product JSON)
      // Fallback: Produktbilder aus der aktuell ausgewählten Karte klonen
      try {
        let productData = null;
        if (handle) {
          const res = await fetch(`/products/${handle}.js`);
          if (res.ok) productData = await res.json();
        }
        // Galerie rendern
        let gallery = [];
        if (productData && Array.isArray(productData.images) && productData.images.length) {
          gallery = productData.images.map(img => (typeof img === 'string' ? img : img.src || img));
        } else {
          // Fallback: Bild aus Karte
          const activeId = root.dataset.selectedDesignId;
          const imgEl = activeId && root.querySelector(`[data-design-card-id="${activeId}"] .design-card__media img`);
          if (imgEl) gallery = [imgEl.src];
        }
        let currentIndex = 0;
        const stage = mediaHolder;
        const renderImage = () => {
          stage.innerHTML = '';
          if (!gallery.length) return;
          const img = document.createElement('img');
          img.src = gallery[currentIndex];
          img.alt = (productData && productData.title) || 'Produktbild';
          stage.appendChild(img);
        };
        renderImage();
        // Titel setzen
        const titleEl = root.querySelector('[data-step3-title]');
        if (titleEl) titleEl.textContent = (productData && productData.title) || (handle ? handle : 'Ausgewähltes Design');
        const prevBtn = root.querySelector('[data-gallery-prev]');
        const nextBtn = root.querySelector('[data-gallery-next]');
        if (prevBtn && nextBtn) {
          prevBtn.onclick = () => { currentIndex = (currentIndex - 1 + gallery.length) % gallery.length; renderImage(); };
          nextBtn.onclick = () => { currentIndex = (currentIndex + 1) % gallery.length; renderImage(); };
        }

        // Farbswatches basierend auf Option "Farbe" der Varianten
        if (productData && Array.isArray(productData.options)) {
          const colorIndex = productData.options.findIndex(o => /farbe|color/i.test(o.name));
          if (colorIndex >= 0) {
            const seen = new Set();
            productData.variants.forEach(variant => {
              const val = variant.options[colorIndex];
              if (!val || seen.has(val)) return;
              seen.add(val);
              const btn = document.createElement('button');
              btn.type = 'button';
              btn.className = 'design-swatch';
              btn.dataset.variantId = variant.id;
              btn.dataset.colorLabel = val;
              // Farbpunkte rendern (simple heuristic)
              const dot = document.createElement('span');
              dot.className = 'design-swatch__dot';
              const colorMap = {
                'schwarz': '#000000','black':'#000000','weiß':'#ffffff','weiss':'#ffffff','white':'#ffffff',
                'rot':'#ff0000','red':'#ff0000','blau':'#0000ff','blue':'#0000ff','grün':'#00a653','gruen':'#00a653','green':'#00a653',
                'gelb':'#ffd600','yellow':'#ffd600','lila':'#7c3aed','purple':'#7c3aed','pink':'#ec4899'
              };
              const key = String(val).toLowerCase();
              const fallback = '#e5e7eb';
              dot.style.cssText = `display:inline-block;width:16px;height:16px;border-radius:999px;border:1px solid #e5e7eb;background:${colorMap[key]||fallback}; margin-right:6px;`;
              btn.appendChild(dot);
              btn.appendChild(document.createTextNode(val));
              btn.addEventListener('click', () => {
                // Preis/Preview aktualisieren
                if (variant.featured_image && variant.featured_image.src) {
                  const idx = gallery.findIndex(u => u.includes(variant.featured_image.src));
                  if (idx >= 0) { currentIndex = idx; renderImage(); }
                  else { gallery[0] = variant.featured_image.src; currentIndex = 0; renderImage(); }
                }
                root.dataset.selectedProduct = String(variant.id);
                updatePriceSummary();
              });
              swatchesHolder.appendChild(btn);
            });
          }
        }
      } catch (err) {
        console.warn('Design-Vorschau konnte nicht geladen werden:', err);
      }
    }

    // Menge in Step 3 per Input
    root.addEventListener('input', (e) => {
      if (e.target.matches('[data-qty-input]')) {
        root.dataset.selectedQty = e.target.value;
        updatePriceSummary();
      }
    });

    // Initial aufräumen
    removeLegacyQtyUI();
  })();
</script>

{% schema %}
{
  "name": "Teamwear Config",
  "tag": "section",
  "class": "section-teamwear-config",
  "settings": [
    {"type": "text", "id": "step1_title", "label": "Step 1 Titel", "default": "Schritt 1: Sportart wählen"},
    {"type": "text", "id": "step1_sub", "label": "Step 1 Untertitel", "default": "Preise für Vereine nach Sportarten"},
    {"type": "text", "id": "cta_choose", "label": "CTA Sport wählen", "default": "Auswählen"},

    {"type": "text", "id": "step2_title", "label": "Step 2 Titel", "default": "Schritt 2: Design wählen"},
    {"type": "text", "id": "step2_sub", "label": "Step 2 Untertitel", "default": "Wähle ein Produkt/Design aus der gewählten Sportart"},
    {"type": "text", "id": "cta_select_design", "label": "CTA Design wählen", "default": "Design auswählen"},

    {"type": "text", "id": "step3_title", "label": "Step 3 Titel", "default": "Schritt 3: Personalisierung"},
    {"type": "text", "id": "step3_sub", "label": "Step 3 Untertitel", "default": "Wähle Farben, Logos und Personalisierungen"}
    ,
    {"type": "header", "content": "Kollektionen je Sportart"},
    {"type": "collection", "id": "bb_collection", "label": "Basketball Kollektion"},
    {"type": "collection", "id": "fb_collection", "label": "Fußball Kollektion"},
    {"type": "collection", "id": "hb_collection", "label": "Handball Kollektion"},
    {"type": "collection", "id": "vb_collection", "label": "Volleyball Kollektion"},
    {"type": "collection", "id": "tt_collection", "label": "Tischtennis Kollektion"},
    {"type": "header", "content": "Kartentexte & Styles"},
    {"type": "text", "id": "bb_title", "label": "Basketball Titel", "default": "Basketball"},
    {"type": "text", "id": "bb_sub", "label": "Basketball Untertitel", "default": "Tank Tops & Shorts"},
    {"type": "text", "id": "bb_icon", "label": "Basketball Icon", "default": "🏀"},
    {"type": "text", "id": "bb_gradient", "label": "Basketball Gradient", "default": "linear-gradient(135deg,#0f172a,#334155)"},
    {"type": "text", "id": "fb_title", "label": "Fußball Titel", "default": "Fußball"},
    {"type": "text", "id": "fb_sub", "label": "Fußball Untertitel", "default": "Trikots & Hosen"},
    {"type": "text", "id": "fb_icon", "label": "Fußball Icon", "default": "⚽"},
    {"type": "text", "id": "fb_gradient", "label": "Fußball Gradient", "default": "linear-gradient(135deg,#052e16,#166534)"},
    {"type": "text", "id": "hb_title", "label": "Handball Titel", "default": "Handball"},
    {"type": "text", "id": "hb_sub", "label": "Handball Untertitel", "default": "Trikots & Shorts"},
    {"type": "text", "id": "hb_icon", "label": "Handball Icon", "default": "🤾"},
    {"type": "text", "id": "hb_gradient", "label": "Handball Gradient", "default": "linear-gradient(135deg,#0c4a6e,#1e40af)"},
    {"type": "text", "id": "vb_title", "label": "Volleyball Titel", "default": "Volleyball"},
    {"type": "text", "id": "vb_sub", "label": "Volleyball Untertitel", "default": "Trikots & Shorts"},
    {"type": "text", "id": "vb_icon", "label": "Volleyball Icon", "default": "🏐"},
    {"type": "text", "id": "vb_gradient", "label": "Volleyball Gradient", "default": "linear-gradient(135deg,#78350f,#a16207)"},
    {"type": "text", "id": "tt_title", "label": "Tischtennis Titel", "default": "Tischtennis"},
    {"type": "text", "id": "tt_sub", "label": "Tischtennis Untertitel", "default": "Trikots & Shorts"},
    {"type": "text", "id": "tt_icon", "label": "Tischtennis Icon", "default": "🏓"},
    {"type": "text", "id": "tt_gradient", "label": "Tischtennis Gradient", "default": "linear-gradient(135deg,#7f1d1d,#b91c1c)"}
    ,
    {"type": "header", "content": "Mengenstaffel & Rabatte"},
    {"type": "text", "id": "tiers_quantities", "label": "Mengen (Komma-getrennt)", "default": "10,20,30,40,50"},
    {"type": "text", "id": "tiers_discounts", "label": "Rabatte in % (Komma-getrennt)", "default": "0,5,7.5,10,12.5"}
  ,
  {"type": "header", "content": "Preise Zusatzoptionen (pro Stück)"},
  {"type": "number", "id": "price_logo", "label": "Logo (pro Stück)", "default": 0},
  {"type": "number", "id": "price_number_chest", "label": "Nummer Brust (pro Stück)", "default": 0},
  {"type": "number", "id": "price_number_back", "label": "Nummer Rücken (pro Stück)", "default": 0},
  {"type": "number", "id": "price_team_name", "label": "Teamname (pro Stück)", "default": 0},
  {"type": "number", "id": "price_player_name", "label": "Spielernamen (pro Stück)", "default": 0}
  ],
  "blocks": [
    {
      "type": "tw_sport",
      "name": "Sportart",
      "settings": [
        {"type": "text", "id": "icon", "label": "Icon (Emoji)", "default": "🏀"},
        {"type": "text", "id": "title", "label": "Titel", "default": "Basketball"},
        {"type": "text", "id": "subtitle", "label": "Untertitel", "default": "Trikots & Shorts"},
        {"type": "collection", "id": "collection", "label": "Kollektion für Designs"},
        {"type": "text", "id": "gradient", "label": "Gradient CSS", "default": "linear-gradient(135deg,#111827,#334155)"}
      ]
    }
  ],
  "presets": [
    {
      "name": "Teamwear Config",
      "blocks": [
        {"type": "tw_sport", "settings": {"icon": "🏀", "title": "Basketball", "subtitle": "Tank Tops & Shorts", "gradient": "linear-gradient(135deg,#0f172a,#334155)"}},
        {"type": "tw_sport", "settings": {"icon": "⚽", "title": "Fußball", "subtitle": "Trikots & Hosen", "gradient": "linear-gradient(135deg,#052e16,#166534)"}},
        {"type": "tw_sport", "settings": {"icon": "🤾", "title": "Handball", "subtitle": "Trikots & Shorts", "gradient": "linear-gradient(135deg,#0c4a6e,#1e40af)"}},
        {"type": "tw_sport", "settings": {"icon": "🏐", "title": "Volleyball", "subtitle": "Trikots & Shorts", "gradient": "linear-gradient(135deg,#78350f,#a16207)"}},
        {"type": "tw_sport", "settings": {"icon": "🏓", "title": "Tischtennis", "subtitle": "Trikots & Shorts", "gradient": "linear-gradient(135deg,#7f1d1d,#b91c1c)"}}
      ]
    }
  ]
}
{% endschema %}


