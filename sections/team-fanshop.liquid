{%- comment -%}
  Team-Fanshop Section
  - Kopfbereich mit Logo, Name, optionalem Intro-Text
  - Produktgrid aus gew√§hlter Kollektion mit einfachen Personalisierungsoptionen
{%- endcomment -%}

<script src="{{ 'teamwear-calculator.js' | asset_url }}" defer></script>

{%- style -%}
  #shopify-section-{{ section.id }} .tf { max-width: 1160px; margin:0 auto; padding: 0 24px; }
  #shopify-section-{{ section.id }} .tf-hero { border:1px solid #e5e7eb; border-radius: 12px; background:#fff; padding: 18px; display:flex; gap: 16px; align-items:center; }
  #shopify-section-{{ section.id }} .tf-hero__logo { width:84px; height:84px; border-radius:999px; overflow:hidden; display:flex; align-items:center; justify-content:center; background:#f3f4f6; flex-shrink: 0; }
  #shopify-section-{{ section.id }} .tf-hero__logo img{ width:100%; height:100%; object-fit:contain; padding: 8px; }
  
  @media (max-width: 640px) {
    #shopify-section-{{ section.id }} .tf-hero { 
      flex-direction: column; 
      text-align: center; 
      padding: 24px 16px; 
      gap: 16px; 
    }
    #shopify-section-{{ section.id }} .tf-hero__logo { 
      width: 100px; 
      height: 100px; 
    }
  }
  #shopify-section-{{ section.id }} .tf-hero__title { margin:0 0 2px; font-weight:800; font-size: clamp(1.25rem, 1rem + .8vw, 1.75rem); }
  #shopify-section-{{ section.id }} .tf-hero__meta { color:#64748b; }
  #shopify-section-{{ section.id }} .tf-intro { margin: 18px 0 8px; color:#475569; text-align:center; }
  #shopify-section-{{ section.id }} .tf-filters { display:flex; gap:8px; justify-content:center; margin: 8px 0 16px; flex-wrap:wrap; }
  #shopify-section-{{ section.id }} .tf-chip { padding:8px 12px; border:1px solid #e5e7eb; border-radius:999px; background:#fff; cursor:pointer; font-weight:600; }
  #shopify-section-{{ section.id }} .tf-chip.is-active { background:#111827; color:#fff; border-color:#111827; }
  #shopify-section-{{ section.id }} .tf-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 14px; max-width: 1200px; margin: 0 auto; }
  @media (max-width: 900px) { #shopify-section-{{ section.id }} .tf-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
  @media (max-width: 640px) { #shopify-section-{{ section.id }} .tf-grid { grid-template-columns: 1fr; } }
  #shopify-section-{{ section.id }} .tf-card { border:1px solid #e5e7eb; background:#fff; border-radius: 12px; overflow:hidden; display:flex; flex-direction:column; }
  #shopify-section-{{ section.id }} .tf-card__media { 
    width: 100%;
    height: 320px;
    background:#f1f5f9; 
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    overflow: hidden;
  }
  
  #shopify-section-{{ section.id }} .tf-card__media img {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }
  
  /* Image Slider */
  #shopify-section-{{ section.id }} .tf-image-slider {
    position: relative;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  #shopify-section-{{ section.id }} .tf-slider-btn {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 32px;
    height: 32px;
    background: rgba(255, 255, 255, 0.9);
    border: 1px solid rgba(0, 0, 0, 0.1);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    opacity: 0.8;
    transition: all 0.3s ease;
    z-index: 10;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }
  
  #shopify-section-{{ section.id }} .tf-slider-btn:hover {
    background: rgba(163, 230, 53, 0.95);
    opacity: 1;
    transform: translateY(-50%) scale(1.1);
    color: #ffffff;
  }
  
  #shopify-section-{{ section.id }} .tf-slider-btn--prev {
    left: 8px;
  }
  
  #shopify-section-{{ section.id }} .tf-slider-btn--next {
    right: 8px;
  }
  
  #shopify-section-{{ section.id }} .tf-zoom-btn {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 32px;
    height: 32px;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(0, 0, 0, 0.1);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    opacity: 0.8;
    transition: all 0.3s ease;
    z-index: 10;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }
  
  #shopify-section-{{ section.id }} .tf-zoom-btn:hover {
    background: rgba(163, 230, 53, 0.95);
    transform: scale(1.1);
    opacity: 1;
  }
  
  #shopify-section-{{ section.id }} .tf-zoom-btn:hover svg {
    color: #ffffff;
  }
  
  #shopify-section-{{ section.id }} .tf-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }
  
  #shopify-section-{{ section.id }} .tf-image.hidden {
    display: none;
  }
  #shopify-section-{{ section.id }} .tf-card__body { padding: 10px; display:grid; gap:8px; }
  #shopify-section-{{ section.id }} .tf-price { font-weight:800; }
  #shopify-section-{{ section.id }} .tf-row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  #shopify-section-{{ section.id }} .tf-input { width:100%; padding:6px 8px; border:1px solid #e5e7eb; border-radius:8px; }
{%- endstyle -%}

{%- liquid
  if collection
    assign team_logo = collection.image
    assign team_name = collection.title
    assign team_sub = collection.description
    assign intro_text = ''
    assign fanshop_collection = collection
  else
    assign team_logo = section.settings.logo
    assign team_name = section.settings.team_name
    assign team_sub = section.settings.team_sub
    assign intro_text = section.settings.intro
    assign fanshop_collection = section.settings.collection
  endif
-%}

<div class="tf">
  <div class="tf-hero">
    <div class="tf-hero__logo">
      {%- if team_logo != blank -%}
        {{ team_logo | image_url: width: 136 | image_tag: loading: 'lazy', alt: team_name | escape }}
      {%- else -%}
        <span aria-hidden="true">üèÄ</span>
      {%- endif -%}
    </div>
    <div>
      <h2 class="tf-hero__title">{{ team_name }}</h2>
      <div class="tf-hero__meta">{{ team_sub }}</div>
    </div>
  </div>

  {%- if intro_text != blank -%}
    <div class="tf-intro">{{ intro_text }}</div>
  {%- endif -%}

  {%- if section.settings.show_filters and fanshop_collection != blank -%}
    <div class="tf-filters" data-filter-chips>
      <button class="tf-chip is-active" data-filter="all">Alle</button>
      {%- if section.settings.filter1_label != blank and section.settings.filter1_tag != blank -%}
        <button class="tf-chip" data-filter="{{ section.settings.filter1_tag | escape }}">{{ section.settings.filter1_label }}</button>
      {%- endif -%}
      {%- if section.settings.filter2_label != blank and section.settings.filter2_tag != blank -%}
        <button class="tf-chip" data-filter="{{ section.settings.filter2_tag | escape }}">{{ section.settings.filter2_label }}</button>
      {%- endif -%}
      {%- if section.settings.filter3_label != blank and section.settings.filter3_tag != blank -%}
        <button class="tf-chip" data-filter="{{ section.settings.filter3_tag | escape }}">{{ section.settings.filter3_label }}</button>
      {%- endif -%}
    </div>
  {%- endif -%}

  <div class="tf-grid" data-product-grid>
    {%- if fanshop_collection != blank -%}
      {%- for product in fanshop_collection.products -%}
        <article class="tf-card" data-product-id="{{ product.selected_or_first_available_variant.id }}" data-tags="{{ product.tags | join: ',' | escape }}">
          <div class="tf-card__media">
            <button type="button" class="tf-zoom-btn" aria-label="Bild vergr√∂√üern" data-zoom-trigger data-product-handle="{{ product.handle }}">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="18" height="18">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v6m3-3H7" />
              </svg>
            </button>
            <div class="tf-image-slider">
              {%- if product.images.size > 1 -%}
                <button type="button" class="tf-slider-btn tf-slider-btn--prev" aria-label="Vorheriges Bild" data-slider-prev>
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M15 18l-6-6 6-6"/>
                  </svg>
                </button>
                <button type="button" class="tf-slider-btn tf-slider-btn--next" aria-label="N√§chstes Bild" data-slider-next>
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 18l6-6-6-6"/>
                  </svg>
                </button>
              {%- endif -%}
              {%- for image in product.images -%}
                <img class="tf-image {% unless forloop.first %}hidden{% endunless %}" 
                     src="{{ image | image_url: width: 800 }}" 
                     alt="{{ product.title | escape }}"
                     loading="lazy"
                     data-image-index="{{ forloop.index0 }}">
              {%- endfor -%}
            </div>
          </div>
          <div class="tf-card__body">
            <div class="tf-card__title" style="font-weight:700;">{{ product.title }}</div>
            <div class="tf-price">{{ product.selected_or_first_available_variant.price | money }}</div>
            {%- assign size_opt = product.options_with_values | where: 'name', 'Gr√∂√üe' -%}
            {%- if size_opt.size > 0 -%}
              <div class="tf-row">
                <label>Gr√∂√üe</label>
                <select class="tf-input" data-variant-size>
                  {%- for opt in size_opt.first.values -%}
                    <option value="{{ opt }}">{{ opt }}</option>
                  {%- endfor -%}
                </select>
              </div>
            {%- endif -%}
            {%- assign color_opt = product.options_with_values | where: 'name', 'Farbe' -%}
            {%- if color_opt.size > 0 -%}
              <div class="tf-row">
                <label>Farbe</label>
                <select class="tf-input" data-variant-color>
                  {%- for opt in color_opt.first.values -%}
                    <option value="{{ opt }}">{{ opt }}</option>
                  {%- endfor -%}
                </select>
              </div>
            {%- endif -%}
            <div class="tf-row">
              <label><input type="checkbox" data-opt-name> Namen hinzuf√ºgen</label>
              <label><input type="checkbox" data-opt-number> Nummer hinzuf√ºgen</label>
            </div>
            <div class="tf-row" data-name-field style="display:none;">
              <input type="text" class="tf-input" placeholder="Name" data-input-name>
            </div>
            <div class="tf-row" data-number-field style="display:none;">
              <input type="text" class="tf-input" placeholder="Nummer" data-input-number>
            </div>
            <div class="tf-row" style="justify-content:flex-end;">
              <button type="button" class="button" data-add-to-cart>In den Warenkorb</button>
            </div>
          </div>
        </article>
      {%- endfor -%}
    {%- else -%}
      <div style="grid-column:1/-1; border:1px dashed #e5e7eb; border-radius: 10px; padding: 12px; background:#fafafa;">Bitte Kollektion ausw√§hlen.</div>
    {%- endif -%}
  </div>
</div>

<!-- Lightbox Modal -->
<div class="tf-lightbox" id="tf-lightbox-{{ section.id }}">
  <div class="tf-lightbox__container">
    <button class="tf-lightbox__close" aria-label="Schlie√üen">√ó</button>
    <button class="tf-lightbox__nav tf-lightbox__nav--prev" aria-label="Zur√ºck">‚Äπ</button>
    <img class="tf-lightbox__image" src="" alt="">
    <button class="tf-lightbox__nav tf-lightbox__nav--next" aria-label="Weiter">‚Ä∫</button>
    <div class="tf-lightbox__counter"><span class="current">1</span> / <span class="total">1</span></div>
  </div>
</div>

<style>
  .tf-lightbox { position:fixed; inset:0; background:rgba(0,0,0,0.95); z-index:9999; display:none; align-items:center; justify-content:center; }
  .tf-lightbox.active { display:flex; }
  .tf-lightbox__container { position:relative; width:90%; max-width:1200px; height:90vh; display:flex; align-items:center; justify-content:center; }
  .tf-lightbox__image { max-width:100%; max-height:90vh; object-fit:contain; border-radius:12px; }
  .tf-lightbox__close { position:absolute; top:20px; right:20px; width:50px; height:50px; background:rgba(255,255,255,0.2); border:none; border-radius:50%; color:#fff; font-size:32px; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:all 0.2s; }
  .tf-lightbox__close:hover { background:rgba(239,68,68,0.9); transform:scale(1.1); }
  .tf-lightbox__nav { position:absolute; top:50%; transform:translateY(-50%); width:60px; height:60px; background:rgba(255,255,255,0.2); border:none; border-radius:50%; color:#fff; font-size:40px; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:all 0.2s; }
  .tf-lightbox__nav:hover { background:rgba(163,230,53,0.9); transform:translateY(-50%) scale(1.1); }
  .tf-lightbox__nav--prev { left:20px; }
  .tf-lightbox__nav--next { right:20px; }
  .tf-lightbox__counter { position:absolute; bottom:30px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.7); color:#fff; padding:8px 16px; border-radius:20px; font-size:14px; }
</style>

<script>
  (function(){
    const root = document.querySelector('#shopify-section-{{ section.id }}');
    if (!root) return;
    
    // LIGHTBOX FUNCTIONALITY
    const lightbox = document.querySelector('#tf-lightbox-{{ section.id }}');
    let currentImages = [];
    let currentIndex = 0;
    
    const updateLightbox = () => {
      if (!currentImages[currentIndex]) return;
      lightbox.querySelector('.tf-lightbox__image').src = currentImages[currentIndex].src;
      lightbox.querySelector('.tf-lightbox__image').alt = currentImages[currentIndex].alt;
      lightbox.querySelector('.current').textContent = currentIndex + 1;
      lightbox.querySelector('.total').textContent = currentImages.length;
      
      lightbox.querySelector('.tf-lightbox__nav--prev').style.display = currentImages.length > 1 ? 'flex' : 'none';
      lightbox.querySelector('.tf-lightbox__nav--next').style.display = currentImages.length > 1 ? 'flex' : 'none';
    };
    
    const openLightbox = (images, startIndex) => {
      currentImages = images;
      currentIndex = startIndex;
      updateLightbox();
      lightbox.classList.add('active');
      document.body.style.overflow = 'hidden';
    };
    
    const closeLightbox = () => {
      lightbox.classList.remove('active');
      document.body.style.overflow = '';
    };
    
    // Zoom Button Clicks - NUR preventDefault, kein stopPropagation!
    root.addEventListener('click', (e) => {
      const zoomBtn = e.target.closest('[data-zoom-trigger]');
      if (zoomBtn) {
        e.preventDefault();
        // KEIN e.stopPropagation() - damit andere Handler funktionieren!
        const card = zoomBtn.closest('.tf-card');
        if (!card) return;
        
        const imgs = Array.from(card.querySelectorAll('.tf-image'));
        const images = imgs.map(img => ({
          src: img.src.replace('width=800', 'width=1200'),
          alt: img.alt
        }));
        const visibleImg = imgs.find(img => !img.classList.contains('hidden'));
        const startIndex = visibleImg ? parseInt(visibleImg.dataset.imageIndex) || 0 : 0;
        
        openLightbox(images, startIndex);
        return; // Fr√ºh beenden aber Propagation erlauben
      }
    });
    
    // Lightbox Controls
    lightbox.querySelector('.tf-lightbox__close').addEventListener('click', closeLightbox);
    lightbox.querySelector('.tf-lightbox__nav--prev').addEventListener('click', () => {
      currentIndex = (currentIndex - 1 + currentImages.length) % currentImages.length;
      updateLightbox();
    });
    lightbox.querySelector('.tf-lightbox__nav--next').addEventListener('click', () => {
      currentIndex = (currentIndex + 1) % currentImages.length;
      updateLightbox();
    });
    lightbox.addEventListener('click', (e) => {
      if (e.target === lightbox) closeLightbox();
    });
    
    document.addEventListener('keydown', (e) => {
      if (!lightbox.classList.contains('active')) return;
      if (e.key === 'Escape') closeLightbox();
      if (e.key === 'ArrowLeft') {
        currentIndex = (currentIndex - 1 + currentImages.length) % currentImages.length;
        updateLightbox();
      }
      if (e.key === 'ArrowRight') {
        currentIndex = (currentIndex + 1) % currentImages.length;
        updateLightbox();
      }
    });
    
    // Image Slider Functionality
    root.querySelectorAll('.tf-card').forEach(card => {
      const images = card.querySelectorAll('.tf-image');
      if (images.length <= 1) return;
      
      let currentIndex = 0;
      const prevBtn = card.querySelector('[data-slider-prev]');
      const nextBtn = card.querySelector('[data-slider-next]');
      
      const showImage = (index) => {
        images.forEach((img, i) => {
          img.classList.toggle('hidden', i !== index);
        });
      };
      
      prevBtn?.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        currentIndex = (currentIndex - 1 + images.length) % images.length;
        showImage(currentIndex);
      });
      
      nextBtn?.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        currentIndex = (currentIndex + 1) % images.length;
        showImage(currentIndex);
      });
    });
    
    // Filter
    const grid = root.querySelector('[data-product-grid]');
    const chips = root.querySelectorAll('[data-filter-chips] .tf-chip');
    chips.forEach(chip => chip?.addEventListener('click', () => {
      chips.forEach(c=>c.classList.remove('is-active'));
      chip.classList.add('is-active');
      const tag = chip.getAttribute('data-filter');
      grid.querySelectorAll('.tf-card').forEach(card => {
        const tags = (card.getAttribute('data-tags')||'').split(',');
        const show = tag === 'all' ? true : tags.includes(tag);
        card.style.display = show ? '' : 'none';
      });
    }));
    
    root.addEventListener('change', (e) => {
      if (e.target.matches('[data-opt-name]')) {
        const card = e.target.closest('.tf-card');
        const field = card.querySelector('[data-name-field]');
        field.style.display = e.target.checked ? 'block' : 'none';
      }
      if (e.target.matches('[data-opt-number]')) {
        const card = e.target.closest('.tf-card');
        const field = card.querySelector('[data-number-field]');
        field.style.display = e.target.checked ? 'block' : 'none';
      }
    });
    
    root.addEventListener('click', async (e) => {
      const btn = e.target.closest('[data-add-to-cart]');
      if (!btn) return;
      const card = btn.closest('.tf-card');
      const productId = Number(card.getAttribute('data-product-id'));
      if (!productId) return;
      const properties = {};
      const nameOn = card.querySelector('[data-opt-name]')?.checked;
      const numberOn = card.querySelector('[data-opt-number]')?.checked;
      if (nameOn) properties['Name'] = card.querySelector('[data-input-name]')?.value || '';
      if (numberOn) properties['Nummer'] = card.querySelector('[data-input-number]')?.value || '';
      try {
        btn.setAttribute('disabled', 'disabled');
        const res = await fetch('/cart/add.js', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
          body: JSON.stringify({ id: productId, quantity: 1, properties })
        });
        if (!res.ok) throw new Error('Cart add failed');
        
        const cartData = await res.json();
        
        // Trigger Cart Update Event
        document.dispatchEvent(new CustomEvent('cart:update', {
          bubbles: true,
          detail: {
            resource: cartData,
            sourceId: productId.toString(),
            data: {
              source: 'fanshop',
              itemCount: 1,
              productId: productId.toString()
            }
          }
        }));
        
        // √ñffne Cart Drawer
        const cartDrawer = document.querySelector('cart-drawer-component');
        if (cartDrawer && typeof cartDrawer.open === 'function') {
          setTimeout(() => cartDrawer.open(), 300);
        }
        
        btn.removeAttribute('disabled');
      } catch(err) { 
        console.error('Add to cart failed:', err);
        btn.removeAttribute('disabled'); 
      }
    });
  })();
</script>

{% schema %}
{
  "name": "Team-Fanshop",
  "tag": "section",
  "class": "section-team-fanshop",
  "settings": [
    {"type": "image_picker", "id": "logo", "label": "Team-Logo"},
    {"type": "text", "id": "team_name", "label": "Teamname", "default": "Vereinsname"},
    {"type": "text", "id": "team_sub", "label": "Untertitel"},
    {"type": "text", "id": "intro", "label": "Intro-Text"},
    {"type": "collection", "id": "collection", "label": "Kollektion (Produkte)"},
    {"type": "checkbox", "id": "show_filters", "label": "Filter-Chips anzeigen", "default": true},
    {"type": "text", "id": "filter1_label", "label": "Filter 1 Label", "default": "Trikots"},
    {"type": "text", "id": "filter1_tag", "label": "Filter 1 Tag (Produkt-Tag)", "default": "trikot"},
    {"type": "text", "id": "filter2_label", "label": "Filter 2 Label", "default": "Fanwear"},
    {"type": "text", "id": "filter2_tag", "label": "Filter 2 Tag (Produkt-Tag)", "default": "fanwear"},
    {"type": "text", "id": "filter3_label", "label": "Filter 3 Label", "default": "Trainingskleidung"},
    {"type": "text", "id": "filter3_tag", "label": "Filter 3 Tag (Produkt-Tag)", "default": "training"}
  ],
  "presets": [ 
    {
      "name": "Team-Fanshop",
      "settings": {
        "team_name": "Mein Verein",
        "team_sub": "Offizielle Fanshop-Produkte",
        "intro": "Entdecken Sie unsere exklusiven Fanartikel mit Personalisierungsoption"
      }
    } 
  ],
  "disabled_on": {
    "groups": ["header", "footer"]
  }
}
{% endschema %}


