{%- comment -%}
  Fanshop Produkte mit Name & Nummer Personalisierung
{%- endcomment -%}

{%- style -%}
  #shopify-section-{{ section.id }} .fanshop {
    max-width: 1200px;
    margin: 0 auto;
    padding: 40px 20px;
  }

  #shopify-section-{{ section.id }} .fanshop__header {
    text-align: center;
    margin-bottom: 40px;
  }

  #shopify-section-{{ section.id }} .fanshop__title {
    font-size: 2.5rem;
    font-weight: 700;
    margin: 0 0 1rem;
    color: var(--color-foreground);
  }

  #shopify-section-{{ section.id }} .fanshop__subtitle {
    font-size: 1.125rem;
    color: #6b7280;
    margin: 0;
  }

  #shopify-section-{{ section.id }} .fanshop__grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 2rem;
    margin-top: 2rem;
  }

  #shopify-section-{{ section.id }} .product-card {
    background: #fff;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    overflow: hidden;
    transition: all 0.3s ease;
  }

  #shopify-section-{{ section.id }} .product-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
  }

  #shopify-section-{{ section.id }} .product-card__image {
    aspect-ratio: 4/3;
    background: #f3f4f6;
    display: grid;
    place-items: center;
    overflow: hidden;
  }

  #shopify-section-{{ section.id }} .product-card__image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  #shopify-section-{{ section.id }} .product-card__content {
    padding: 1.5rem;
  }

  #shopify-section-{{ section.id }} .product-card__title {
    font-size: 1.25rem;
    font-weight: 700;
    margin: 0 0 0.5rem;
  }

  #shopify-section-{{ section.id }} .product-card__price {
    font-size: 1.125rem;
    font-weight: 600;
    color: #059669;
    margin: 0 0 1rem;
  }

  #shopify-section-{{ section.id }} .product-options {
    display: grid;
    gap: 1rem;
    margin-bottom: 1.5rem;
  }

  #shopify-section-{{ section.id }} .option-group {
    display: grid;
    gap: 0.5rem;
  }

  #shopify-section-{{ section.id }} .option-label {
    font-weight: 600;
    color: #374151;
  }

  #shopify-section-{{ section.id }} .option-select,
  #shopify-section-{{ section.id }} .option-input {
    padding: 0.75rem;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    font-size: 1rem;
  }

  #shopify-section-{{ section.id }} .personalization {
    background: #f9fafb;
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 1rem;
  }

  #shopify-section-{{ section.id }} .personalization__title {
    font-weight: 600;
    margin: 0 0 0.75rem;
    color: #374151;
  }

  #shopify-section-{{ section.id }} .checkbox-group {
    display: flex;
    gap: 1rem;
    margin-bottom: 0.75rem;
  }

  #shopify-section-{{ section.id }} .checkbox-label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
  }

  #shopify-section-{{ section.id }} .personalization-input {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    margin-top: 0.5rem;
    display: none;
  }

  #shopify-section-{{ section.id }} .add-to-cart-btn {
    width: 100%;
    background: #059669;
    color: white;
    border: none;
    padding: 1rem;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }

  #shopify-section-{{ section.id }} .add-to-cart-btn:hover {
    background: #047857;
  }

  #shopify-section-{{ section.id }} .add-to-cart-btn:disabled {
    background: #9ca3af;
    cursor: not-allowed;
  }
{%- endstyle -%}

<div class="fanshop">
  <div class="fanshop__header">
    <h2 class="fanshop__title">{{ section.settings.title }}</h2>
    {%- if section.settings.subtitle != blank -%}
      <p class="fanshop__subtitle">{{ section.settings.subtitle }}</p>
    {%- endif -%}
  </div>

  <div class="fanshop__grid">
    {%- if section.settings.collection != blank -%}
      {%- for product in section.settings.collection.products -%}
        {%- if forloop.index <= section.settings.products_limit -%}
        <div class="product-card" data-product-id="{{ product.selected_or_first_available_variant.id }}">
          <div class="product-card__image">
            {%- if product.featured_image -%}
              {{ product.featured_image | image_url: width: 600 | image_tag: loading: 'lazy', alt: product.title | escape }}
            {%- else -%}
              <span style="font-size: 3rem; color: #9ca3af;">üì¶</span>
            {%- endif -%}
          </div>
          
          <div class="product-card__content">
            <h3 class="product-card__title">{{ product.title }}</h3>
            <div class="product-card__price">{{ product.selected_or_first_available_variant.price | money }}</div>
            
            <div class="product-options">
              {%- assign size_option = product.options_with_values | where: 'name', 'Gr√∂√üe' | first -%}
              {%- if size_option -%}
                <div class="option-group">
                  <label class="option-label">Gr√∂√üe</label>
                  <select class="option-select" data-option="size">
                    {%- for value in size_option.values -%}
                      <option value="{{ value }}">{{ value }}</option>
                    {%- endfor -%}
                  </select>
                </div>
              {%- endif -%}
              
              {%- assign color_option = product.options_with_values | where: 'name', 'Farbe' | first -%}
              {%- if color_option -%}
                <div class="option-group">
                  <label class="option-label">Farbe</label>
                  <select class="option-select" data-option="color">
                    {%- for value in color_option.values -%}
                      <option value="{{ value }}">{{ value }}</option>
                    {%- endfor -%}
                  </select>
                </div>
              {%- endif -%}
            </div>

            <div class="personalization">
              <div class="personalization__title">Personalisierung</div>
              <div class="checkbox-group">
                <label class="checkbox-label">
                  <input type="checkbox" data-enable="name">
                  Name hinzuf√ºgen
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" data-enable="number">
                  Nummer hinzuf√ºgen
                </label>
              </div>
              <input type="text" class="personalization-input" data-input="name" placeholder="Name eingeben">
              <input type="text" class="personalization-input" data-input="number" placeholder="Nummer eingeben">
            </div>

            <button type="button" class="add-to-cart-btn" data-add-to-cart>
              In den Warenkorb
            </button>
          </div>
        </div>
        {%- endif -%}
      {%- endfor -%}
    {%- else -%}
      <div style="grid-column: 1 / -1; text-align: center; padding: 3rem; background: #f9fafb; border-radius: 12px; border: 2px dashed #d1d5db;">
        <p style="font-size: 1.125rem; color: #6b7280; margin: 0;">Bitte w√§hlen Sie eine Kollektion aus, um Produkte anzuzeigen.</p>
      </div>
    {%- endif -%}
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const section = document.querySelector('#shopify-section-{{ section.id }}');
  if (!section) return;

  // Personalisierung Toggle
  section.addEventListener('change', function(e) {
    if (e.target.matches('[data-enable]')) {
      const type = e.target.getAttribute('data-enable');
      const card = e.target.closest('.product-card');
      const input = card.querySelector(`[data-input="${type}"]`);
      
      if (input) {
        input.style.display = e.target.checked ? 'block' : 'none';
        if (!e.target.checked) {
          input.value = '';
        }
      }
    }
  });

  // Add to Cart
  section.addEventListener('click', async function(e) {
    if (!e.target.matches('[data-add-to-cart]')) return;
    
    const button = e.target;
    const card = button.closest('.product-card');
    const productId = card.getAttribute('data-product-id');
    
    if (!productId) return;
    
    // Sammle Produktoptionen
    const properties = {};
    
    // Name und Nummer
    const nameInput = card.querySelector('[data-input="name"]');
    const numberInput = card.querySelector('[data-input="number"]');
    const nameEnabled = card.querySelector('[data-enable="name"]').checked;
    const numberEnabled = card.querySelector('[data-enable="number"]').checked;
    
    if (nameEnabled && nameInput && nameInput.value.trim()) {
      properties['Name'] = nameInput.value.trim();
    }
    
    if (numberEnabled && numberInput && numberInput.value.trim()) {
      properties['Nummer'] = numberInput.value.trim();
    }
    
    try {
      button.disabled = true;
      button.textContent = 'Wird hinzugef√ºgt...';
      
      const response = await fetch('/cart/add.js', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        body: JSON.stringify({
          id: parseInt(productId),
          quantity: 1,
          properties: properties
        })
      });
      
      if (response.ok) {
        button.textContent = '‚úì Hinzugef√ºgt!';
        setTimeout(() => {
          button.textContent = 'In den Warenkorb';
          button.disabled = false;
        }, 2000);
        
        // Optional: Warenkorb-Drawer √∂ffnen oder Seite aktualisieren
        if (window.theme && window.theme.cart) {
          window.theme.cart.refresh();
        }
      } else {
        throw new Error('Fehler beim Hinzuf√ºgen');
      }
    } catch (error) {
      button.textContent = 'Fehler - Erneut versuchen';
      button.disabled = false;
      console.error('Cart add error:', error);
    }
  });
});
</script>

{% schema %}
{
  "name": "Fanshop Produkte",
  "tag": "section",
  "class": "section-fanshop-products",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "√úberschrift",
      "default": "Fanshop"
    },
    {
      "type": "text",
      "id": "subtitle",
      "label": "Untertitel",
      "default": "Personalisierbare Produkte mit Name und Nummer"
    },
    {
      "type": "collection",
      "id": "collection",
      "label": "Produktkollektion"
    },
    {
      "type": "range",
      "id": "products_limit",
      "label": "Anzahl Produkte",
      "min": 3,
      "max": 12,
      "step": 1,
      "default": 6
    }
  ],
  "presets": [
    {
      "name": "Fanshop Produkte",
      "settings": {
        "title": "Fanshop",
        "subtitle": "Personalisierbare Produkte mit Name und Nummer"
      }
    }
  ]
}
{% endschema %}
